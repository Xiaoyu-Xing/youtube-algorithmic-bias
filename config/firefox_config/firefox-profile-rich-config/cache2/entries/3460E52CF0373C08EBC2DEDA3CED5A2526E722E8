/*
buildStripeMetadata: takes four params:
    obj to be modified,
    currency (default USD),
    recurring (default false),
    subType (default monthly)
    fn Adds metadata properties to obj directly.
*/
function buildStripeMetadata(obj, curr, recurring, subType) {
    obj.userid = getUserId();
    obj.tracking = recordTracking();
    obj.locale = getLanguage();
    obj.country = getCountryCode();
    obj.ga_id = getGAID();
    obj.premium = "false";
    obj.premium_cid = "0";
    obj.premium_sid = "0";
    obj.currency = curr;
    obj.recurring = recurring;
    obj.subType = "";
    if (recurring === true) {
      /* subType is one of "monthly" "yearly" and only has an
       * effect if recurring is True */
      obj.subType = subType;
    }

    if (typeof isPremium === "function" && isPremium()) {
        obj.premium = "true";
        obj.premium_cid = getPremiumCid();
        obj.premium_sid = getPremiumSid();
    }
    if (typeof _experiment !== 'undefined') {
        obj.experiment = _experiment.name('Stripe');
        obj.experiment_id = _experiment.experimentId('Stripe');
        obj.variant = _experiment.variant('Stripe');
        obj.variant_index = _experiment.variantIndex('Stripe');
    }
}
/* queryString creates a string of "key=value" from an object of key:value 
    => "key=value" pairs are concatenated with "&"
    => string is prepended with a "?"
    => returns empty string for empty object, non-object, null, or undefined.
*/
function queryString(obj) {
    if (obj === null || typeof obj !== "object") { return ""; }
    var concatenated = Object.keys(obj).map(function(key) {
        return [key, obj[key]].join("=");
    }).join("&"); 
    if (concatenated.length > 0) { 
        return "&" + concatenated; 
    } else {
        return "";
    }
}
/* validateThankYouPage checks thePage for a URL and query params and returns them if they exist
    => if no URL, or missing query params, it returns a default and warns if query parameters are being ignored
*/
function validateThankYouPage(thePage) { // VALIDATE that queryParams exists
    var defaultPage = { url: "https://getadblock.com/thanks.html", queryParams: {} };
    if (thePage !== null && typeof thePage === "object") {
        if (thePage.url && typeof thePage.url === "string" && thePage.url.length !== 0) {
            if (thePage.queryParams && typeof thePage.queryParams === "object") {
                return thePage;
            }
        } else if (thePage.queryParams) {
            _logV2Error("Custom thank you page query params and window opening behavior ignored: no URL specified.");
        }
    } 
    return defaultPage;
}

/*
To use:

Paypal.init(settings); // Makes the button initiate the PayPal payment.

When the payment button is clicked, the user will be directed to PayPal to complete their
purchase.
*/
var Paypal = {
    //  Initialize PayPal button.  settings object contains:
    //    button - DOM object: able to receive 'click' event
    //    getDollarsString - function(): a function that should return the number of
    //      dollars to be charged.  Format is a %.2f string, e.g. "44.50" or "5.00".  May
    //      be called multiple times.
    //    buttonClickPreCheck - function():  Function that is called before button click is
    //      followed through.  Basically lets the users of the object write a function that can
    //      check params, or whatever, to stop the button click from continuing.  E.g. check
    //      that amount is of a certain value.
    init: function(settings) {
        this._settings = settings;
        this.testmode = settings.testmode || false;
        var AUX_LIVE = {
            email: "adblockforchrome@gmail.com",
            url: "https://www.paypal.com/cgi-bin/webscr"
        };
        var AUX_TEST = {
            email: "adblock-sandbox@getadblock.com",
            url: "https://www.sandbox.paypal.com/cgi-bin/webscr"
        };
        this.AUX = (this.testmode ? AUX_TEST : AUX_LIVE);
        if (settings.button != null) {
            $(settings.button).click(function() {
                if (typeof settings.buttonClickPreCheck === "function" && settings.buttonClickPreCheck() === false) {
                // something is wrong, don't continue with PayPal request
                return;
                }
                Paypal.submitForm(this);
                return false;
            });
        }
    },
  
    submitForm: function(element) {
        if ($(element).hasClass('paypal-button-grey') || $(element).hasClass('disabled')) {
            return false;
        }
        var form = Paypal._buildForm(element);
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);

        var amount = this._settings.getDollarsString(element) * 100;

        var subType = "";
        var isSub = false;
        if (typeof this._settings.recurring === 'function' && this._settings.recurring()) {
            isSub = true;
            if (typeof this._settings.subType === 'function') {
                subType = this._settings.subType();
            }
        }
        _logV2PaymentButtonClick("PayPal", amount, "", isSub, subType);
        if (typeof this._settings.buttonClickCallback === "function") {
            this._settings.buttonClickCallback();
        }
    },

  // Return a jQuery object pointing to a DOM form ready to submit to PayPal.
  _buildForm: function(element) {
        var form = document.createElement('form');
        form.action = this.AUX.url; 
        form.method = "post";
        form.name = "_xclick";
        form.target = "_blank";
        // Returns thank you page url
        var set_typ = function() {
            return "https://getadblock.com/thanks.html?utm_nooverride=1";
        };
        var node = document.createElement('input');
        node.type = 'hidden';
        var add = function(name, value) {
            node.name = name;
            node.value = value;
            form.appendChild(node.cloneNode());
        };
        var isMonthly = false;
        var isSub = false;
        if (typeof this._settings.recurring === 'function' && this._settings.recurring()) {
            if (typeof this._settings.subType === 'function') {
                isMonthly = this._settings.subType() === 'monthly';
                isSub = true;
            }
        }
        var curr = typeof this._settings.currency === 'function' ? this._settings.currency() : "USD";
        var itemName = typeof this._settings.itemName === 'function' ? this._settings.itemName(element) : "AdBlock";
        add("item_name", itemName);
        add("cmd", isSub ? "_xclick-subscriptions" : "_xclick");
        add("currency_code", curr);
        add(isSub ? "a3" : "amount", this._settings.getDollarsString(element));
        if (isSub) {
            add("p3", "1"); // subscribe 1
            add("t3", isMonthly ? "M" : "Y"); // month
            add("src", "1"); // recurring
            add("sra", "1"); // try again if payment fails
        }
        var locale = typeof this._settings.locale === 'function' ? this._settings.locale() : "";
        if (locale !== "") {
            add("lc", locale);
        }
        add("no_note", "1");
        var trans_id = Math.floor((Math.random()*10000000)+10000000);
        add("business", this.AUX.email);
        var typ = "";
        if (typeof isPremium === "function" && isPremium() === true) {
            typ = typeof this._settings.thankYouPage === 'function' ? this._settings.thankYouPage() : set_typ();
            add("return", typ + "?u=" + getUserIdOrUnknown() + "&transid=" + trans_id);
        } else { 
            typ = validateThankYouPage(this._settings.thankYouPage);
            add("return", typ.url + "?u=" + getUserIdOrUnknown() + queryString(typ.queryParams));
        }
        add("cbt", "Return to AdBlock");
        add("item_number", recordTracking());
        add("custom", getPurchaseMetadata('PayPal', this.testmode));
        var image_url = "https://getadblock.com/images/logo_adblock_small.png";
        if (typeof isPremium === "function" && isPremium()) {
            // TODO(stephen): Change this once premium code gets to prod
            var image_url = "https://getadblock.com/premium/images/AdBlockPremium_150x50.png";
        }
        add("cpp_logo_image", image_url);
        add("image_url", image_url);

        return form;
    }
};

/*
To use:

StripeAB.init(settings); // must be called 1st.  Makes the button respond to clicks.

When thePaymentButton is clicked, a payment to Stripe will be made via the
AdBlock payment server.  settings.onSuccess(new_order_id) will be called when
it succeeds.  If you then request an email address from the user, once you have
it you can call:
*/
var StripeAB = {
    // Initialize StripeAB.  settings object contains:
    //   button - DOM object: able to receive 'click' event
    //   getAmountCents - function(): a function that should return the integer number of
    //     cents to be charged.  May be called multiple times.
    //   onAjaxStart? - function(): called with when AJAX to server starts
    //   onAjaxComplete? - function(): called when AJAX to server ends
    //   onSuccess? - function(new_order_id): called when charge succeeds.  You
    //     might hide the buttons and show an email request form at this point.
    //   onError? - [optional] function(errorMessage): called when either AJAX request to pmt server fails or
    //      pmt itself fails (e.g., wrong CVC, expired CC). Defaults to window.alert(errorMessage)
    //   testmode? - bool: true if Stripe testmode, defaults to false
    //   buttonClickPreCheck? - function():  Function that is called before button click is
    //     followed through.  Basically lets the users of the object write a function that can
    //     check params, or whatever, to stop the button click from continuing.  E.g. check
    //     that amount is of a certain value.
    //   thankYouPage - [optional]: Object that contains the following keys:
    //       => [required, default: "https://getadblock.com/thanks.html"] url (string): page to redirect to *without* any query parameters appended
    //       => [optional, default: {}] queryParams (object): key-value pairs (e.g., {"transid":1234} becomes '&transid=1234')
    //       => [optional, default: false] newWindow (boolean): true => window.open(url) false => window.location.href = url;
    //     If no url is provided, optional parameters are ignored and we fallback to defaults:
    //       => If !chargeResult.success => "https://getadblock.com/thanks.html?u=" + that.DATA.userid;
    //       => Else => "https://getadblock.com/thanks.html?u=" + that.DATA.userid + "&o=" + chargeResult.charge_id;
    // Needed properties:
    //   userid - string: AdBlock userid, access right before submitting purchase using
    //     getUserId()
    init: function (settings) {
        this.DATA = {
            testmode: settings.testmode || false,
        };
        var AUX_LIVE = {
            key: "pk_live_Zr0d52ZJA1wFGrhLGcIT2ZhB",
            charge_url: "https://getadblock.appspot.com/stripe/charges",
        };
        var AUX_TEST = {
            key: "pk_test_iqOTH7z37sT1seSKNzhhKzUu", //adblock's test key
            charge_url: "https://getadblock.appspot.com/stripe/charges", //adblock's charge url
        };

        this.AUX = (settings.testmode ? AUX_TEST : AUX_LIVE);
        this._onAjaxStart = settings.onAjaxStart || function () {};
        this._buttonClickCallback = settings.buttonClickCallback || function () {};
        this._onAjaxComplete = settings.onAjaxComplete || function () {};
        this._getAmountCents = settings.getAmountCents;
        this.onSuccess = settings.onSuccess || undefined;
        this._wireUpButton(settings.button);
        this._buttonClickPreCheck = typeof settings.buttonClickPreCheck === 'function' ? settings.buttonClickPreCheck : function() {return true;};
        this._currency = typeof settings.currency === 'function' ? settings.currency : function() {return "USD"};
        this._locale = typeof settings.locale === 'function' ? settings.locale : function() {return 'en';};
        this._description = typeof settings.description === 'function' ? settings.description : function() {
            return 'Securely processed by Stripe.com';
        }
        this._recurring = typeof settings.recurring === 'function' ? settings.recurring : function() {return false;};
        this._getSubType = typeof settings.subType === 'function' ? settings.subType : function() {return "monthly";};
        this._thankYouPage = validateThankYouPage(settings.thankYouPage);
        this._onCheckoutClose = typeof settings.onCheckoutClose === 'function' ? settings.onCheckoutClose : function () {};
        this._onError = typeof settings.onError === 'function' ? settings.onError : function (msg) {
            alert("Sorry, but there was a problem:\n\n" + msg + "\n\nPlease try again.");
        };
    },
    _wireUpButton: function (buttonEl) {
        var that = this;
        $(buttonEl).click(function () {
            if (that._buttonClickPreCheck() === false) {
                return;
            }

            if ($(buttonEl).hasClass('disabled')) {
                return false;
            }
            that.DATA.amount_cents = that._getAmountCents();

            var buttonType = "Stripe";

            _logV2PaymentButtonClick("Stripe", that.DATA.amount_cents, buttonType, that._recurring(), that._getSubType());

            if (buttonType === "Stripe") {
                var name = 'AdBlock';
                if (typeof isPremium === "function" && isPremium()) {
                    name = 'AdBlock Premium';
                }
                var obj = {
                    name: name,
                    key: that.AUX.key,
                    amount: that.DATA.amount_cents,
                    description: that._description(),
                    //panelLabel: "Pay",
                    currency: that._currency(),
                    locale: that._locale(),
                    closed: that._onCheckoutClose,
                    token: function (res) {
                        that._onAjaxStart();
                        that.DATA.stripeToken = res.id;
                        that.DATA.email = res.email;
                        buildStripeMetadata(that.DATA, that._currency(), that._recurring(), that._getSubType());
                        $.ajax({
                            type: "POST",
                            url: that.AUX.charge_url,
                            data: that.DATA,
                            dataType: "json",
                            success: function (chargeResult) {
                                var thankYouPage = that._thankYouPage;
                                var query = "?u=" + that.DATA.userid + queryString(thankYouPage.queryParams);
                                var destination = "";
                                if (!chargeResult.success && getSource() !== "SY" && getSource() !== "SG") {
                                    that._onError(chargeResult.error);
                                } else {
                                    if (typeof that.onSuccess === "function") {
                                        that.onSuccess('');
                                    } else {
                                        window.location.href = thankYouPage.url + query;
                                    }
                                }
                            },
                            error: function () {
                                that._onError("Unknown error. Please e-mail help@getadblock.com for assistance.");
                            },
                            complete: that._onAjaxComplete,
                        });
                    }
                };
                if (typeof that._recurring === 'function' && that._recurring() === true) {
                    obj.panelLabel = 'Subscribe {{amount}} / month';
                }
                StripeCheckout.open(obj);
            }
            return false;
        });
    }
};

/*
StripeSourceInstance
    The non-singleton version of StripeSource.
    Supports multiple sources on the same page.
    Called with same settings parameter as StripeSource.init(settings)
*/

var StripeSourceInstance = function(settings) {
    this.DATA = {
        testmode: settings.testmode || false,
    };
    var AUX_LIVE = {
        key: "pk_live_Zr0d52ZJA1wFGrhLGcIT2ZhB",
        source_url: "https://getadblock.appspot.com/stripe/sources",
    };
    var AUX_TEST = {
        key: "pk_test_iqOTH7z37sT1seSKNzhhKzUu", //adblock's test key
        source_url: "https://getadblock.appspot.com/stripe/sources", //adblock's charge url
    };

    this.AUX = (settings.testmode ? AUX_TEST : AUX_LIVE);
    this._onAjaxStart = settings.onAjaxStart || function () {};
    this._onAjaxComplete = settings.onAjaxComplete || function () {};
    this._getAmountCents = settings.getAmountCents;
    this.onSuccess = settings.onSuccess || function () {};
    this._buttonClickPreCheck = typeof settings.buttonClickPreCheck === 'function' ? settings.buttonClickPreCheck : function() {return true;};
    this._wireUpButton(settings.button);
    this._currency = typeof settings.currency === 'function' ? settings.currency : function() {return "USD"};
    this._locale = typeof settings.locale === 'function' ? settings.locale : function() {return 'en';};
    this._description = typeof settings.description === 'function' ? settings.description : function() {
        return 'Securely processed by Stripe.com';
    }
    this._recurring = typeof settings.recurring === 'function' ? settings.recurring : function() {return false;};
    this._getSubType = typeof settings.subType === 'function' ? settings.subType : function() {return "monthly";};
    this._getSourceType = typeof settings.sourceType === 'function' ? settings.sourceType : function() {return "none";};
}

StripeSourceInstance.prototype._showError = function (msg) {
    alert("Sorry, but there was a problem:\n\n" + msg + "\n\nPlease try again.");
}

StripeSourceInstance.prototype._wireUpButton = function (buttonEl) {
    var that = this;
    $(buttonEl).click(function() {
        if ($(buttonEl).hasClass('disabled')) {
            return false;
        }
        if (that._buttonClickPreCheck() === false) {
            return;
        }
        that.DATA.amount_cents = that._getAmountCents();

        // YOU HAVE TO SET THE TYPE CORRECTLY
        var buttonType = that._getSourceType();
        if (buttonType === "none") {
            _logV2Error("Source not set up correctly");
            alert("Source not set up correctly\n\nPlease post a ticket to help.getadblock.com");
        }
        that.DATA.type = buttonType;

        _logV2PaymentButtonClick(buttonType, that.DATA.amount_cents, buttonType, that._recurring(), that._getSubType());

        that._onAjaxStart();
        buildStripeMetadata(that.DATA, that._currency(), that._recurring(), that._getSubType());
        $.ajax({
            type: "POST",
            url: that.AUX.source_url,
            data: that.DATA,
            dataType: 'json',
            success: function (sourceResult) {
                if (sourceResult.success) {
                    that.onSuccess(sourceResult.redirect_url);
                }
            },
            error: function (jqXHR, number, text) {
                that._showError("Unknown error.");
                // console.log("number:" + number + "text: " + text);
            },
            complete: that._onAjaxComplete,
        });
        return false;
    });
}

/*
StripeSource: a configurable singleton to pay via Stripe Sources
To use:

StripeSource.init(settings); // must be called 1st.  Makes the button respond to clicks.

When thePaymentButton is clicked, a payment to Stripe will be made via the
AdBlock payment server.  settings.onSuccess(new_order_id) will be called when
it succeeds.  If you then request an email address from the user, once you have
it you can call:
*/
var StripeSource = {
    // Initialize StripeSource.  settings object contains:
    //   button - DOM object: able to receive 'click' event
    //   getAmountCents - function(): a function that should return the integer number of
    //     cents to be charged.  May be called multiple times.
    //   onAjaxStart? - function(): called with when AJAX to server starts
    //   onAjaxComplete? - function(): called when AJAX to server ends
    //   onSuccess? - function(new_order_id): called when charge succeeds.  You
    //     might hide the buttons and show an email request form at this point.
    //   testmode? - bool: true if Stripe testmode, defaults to false
    // Needed properties:
    //   userid - string: AdBlock userid, access right before submitting purchase using
    //     getUserId()
    init: function (settings) {
        this.DATA = {
            testmode: settings.testmode || false,
        };
        var AUX_LIVE = {
            key: "pk_live_Zr0d52ZJA1wFGrhLGcIT2ZhB",
            source_url: "https://getadblock.appspot.com/stripe/sources",
        };
        var AUX_TEST = {
            key: "pk_test_iqOTH7z37sT1seSKNzhhKzUu", //adblock's test key
            source_url: "https://getadblock.appspot.com/stripe/sources", //adblock's charge url
        };

        this.AUX = (settings.testmode ? AUX_TEST : AUX_LIVE);
        this._onAjaxStart = settings.onAjaxStart || function () {};
        this._onAjaxComplete = settings.onAjaxComplete || function () {};
        this._getAmountCents = settings.getAmountCents;
        this.onSuccess = settings.onSuccess || function () {};
        this._buttonClickPreCheck = typeof settings.buttonClickPreCheck === 'function' ? settings.buttonClickPreCheck : function() {return true;};
        this._wireUpButton(settings.button);
        this._currency = typeof settings.currency === 'function' ? settings.currency : function() {return "USD"};
        this._locale = typeof settings.locale === 'function' ? settings.locale : function() {return 'en';};
        this._description = typeof settings.description === 'function' ? settings.description : function() {
            return 'Securely processed by Stripe.com';
        }
        this._recurring = typeof settings.recurring === 'function' ? settings.recurring : function() {return false;};
        this._getSubType = typeof settings.subType === 'function' ? settings.subType : function() {return "monthly";};
        this._getSourceType = typeof settings.sourceType === 'function' ? settings.sourceType : function() {return "none";};
    },
    _showError: function (msg) {
        alert("Sorry, but there was a problem:\n\n" + msg + "\n\nPlease try again.");
    },
    _wireUpButton: function (buttonEl) {
        var that = this;
        $(buttonEl).click(function() {
            if ($(buttonEl).hasClass('disabled')) {
                return false;
            }
            if (that._buttonClickPreCheck() === false) {
                return;
            }
            that.DATA.amount_cents = that._getAmountCents();

            // YOU HAVE TO SET THE TYPE CORRECTLY
            var buttonType = that._getSourceType();
            if (buttonType === "none") {
                _logV2Error("Source not set up correctly");
                alert("Source not set up correctly\n\nPlease post a ticket to help.getadblock.com");
            }
            that.DATA.type = buttonType;

            _logV2PaymentButtonClick(buttonType, that.DATA.amount_cents, buttonType, that._recurring(), that._getSubType());

            that._onAjaxStart();
            buildStripeMetadata(that.DATA, that._currency(), that._recurring(), that._getSubType());
            $.ajax({
                type: "POST",
                url: that.AUX.source_url,
                data: that.DATA,
                dataType: 'json',
                success: function (sourceResult) {
                    if (sourceResult.success) {
                        that.onSuccess(sourceResult.redirect_url);
                    }
                },
                error: function (jqXHR, number, text) {
                    that._showError("Unknown error.");
                    console.log(jqXHR);
                    console.log("number:" + number + "text: " + text);
                },
                complete: that._onAjaxComplete,
            });

            return false;
        });
    },
};

/*
Stripe Payment Request API - https://stripe.com/docs/payment-request-api
Supported by Chrome Desktop, Chrome Android, Microsoft Edge, and
Apple Pay for users with a configured Wallet and compatible device.

To use: StripePaymentRequestAPI.init(settings, unsupportedCallback);
    => settings [required] - same base settings object as StripeAB with the following additions:
        => isApplePay [optional] - if true, the payment request will be configured for Apple Pay.
        => onSetupSuccess [optional] - function that will be called if the payment method
            being initialized is supported by the user's browser.
        => onSetupFailure [required] - in the event that the PaymentRequestAPI is unavailable, this can
            be used to provide fallback to default StripeAB handling, e.g., StripeAB.init(settings);
*/
var StripePaymentRequestAPI = {
    init: function (settings) {
        if (typeof settings.onSetupFailure !== "function") {
            console.error("You cannot initialize Payment Request API without a fallback method for unsupported browsers");
            _logV2Error("Attempted to initialize Payment Request API without an unsupported browser fallback method.");
            return false;
        }

        this.DATA = {
            testmode: settings.testmode || false,
        };

        var AUX_LIVE = {
            key: "pk_live_Zr0d52ZJA1wFGrhLGcIT2ZhB",
            charge_url: "https://getadblock.appspot.com/stripe/charges",
        };
        var AUX_TEST = {
            key: "pk_test_iqOTH7z37sT1seSKNzhhKzUu", // AdBlock's test key
            charge_url: "https://getadblock.appspot.com/stripe/charges", // AdBlock's test charge url
        };

        this.AUX = (settings.testmode ? AUX_TEST : AUX_LIVE);
        this._onSetupFailure = settings.onSetupFailure;
        this._onSetupSuccess = typeof settings.onSetupSuccess !== "undefined" ? settings.onSetupSuccess : function() {return true;}
        this._onAjaxStart = settings.onAjaxStart || function () {};
        this._buttonClickCallback = settings.buttonClickCallback || function () {};
        this._onAjaxComplete = settings.onAjaxComplete || function () {};
        this._getAmountCents = settings.getAmountCents;
        this._onSuccess = settings.onSuccess || undefined;
        this._buttonClickPreCheck = typeof settings.buttonClickPreCheck === "function" ? settings.buttonClickPreCheck : function() {return true;};
        this._currency = typeof settings.currency === "function" ? settings.currency : function() {return "USD";};
        this._recurring = typeof settings.recurring === "function" ? settings.recurring : function() {return false;};
        this._getSubType = typeof settings.subType === "function" ? settings.subType : function() {return "monthly";};
        this._country = typeof getCountryCode === "function" ? getCountryCode : function() {return "US";}
        this._thankYouPage = validateThankYouPage(settings.thankYouPage);
        this._onError = typeof settings.onError === "function" ? settings.onError : function (msg) {
            // Payment Requests launch a modal. Do not use window.alert here. It pops *under* and hangs indefinitely.
            console.error("There was a problem: ", msg);
        };
        this._isApplePay = (typeof settings.isApplePay !== "undefined" && settings.isApplePay === true) ? true : false;
        this._buttonType = this._isApplePay === true ? "Stripe ApplePay" : "Stripe PaymentRequestAPI";
        this._paymentRequest = Stripe(this.AUX.key).paymentRequest({
            country: this._country(),
            currency: this._currency().toLowerCase(),
            total: {
                label: "A pending amount to be updated on button click.",
                amount: 500,
                pending: true
            },
            requestPayerEmail: true
        });
        var that = this;
        this._paymentRequest.canMakePayment().then(function(result) {
            if (result !== null && typeof result === "object") {
                if (that._isApplePay === true && result.applePay === false) {
                    // We want Apple Pay, but it's not supported
                    that._onSetupFailure();
                    return false;
                }
                // Supported. Complete initialization.
                that._onSetupSuccess();
                that._initializeTokenListener();
                that._wireUpButton(settings.button);
            } else { // Payment not supported / missing CC / etc.
                that._onSetupFailure();
                return false;
            }
        });
    },
    _initializeTokenListener: function() {
        var that = this;
        that._paymentRequest.on("token", function(ev) { // When we receive a token...
            that.DATA.stripeToken = ev.token.id;
            that.DATA.email = ev.payerEmail;
            that.DATA.button_type = that._buttonType;
            buildStripeMetadata(that.DATA, that._currency(), that._recurring(), that._getSubType());
            that._onAjaxStart();
            $.ajax({ // ...then we can post a charge to the back-end
                type: "POST",
                url: that.AUX.charge_url,
                data: that.DATA,
                dataType: "json",
                success: function (chargeResult) {
                    if (!chargeResult.success && getSource() !== "SY" && getSource() !== "SG") {
                        // Report to the browser that the payment failed, prompting it to
                        // re-show the payment interface, or show an error message and close
                        // the payment interface.
                        ev.complete("fail");
                        that._onError(chargeResult.error);
                    } else {
                        // Report to the browser that the payment was successful, prompting
                        // it to close the browser payment interface.
                        ev.complete("success");
                        if (typeof that._onSuccess === "function") {
                            that._onSuccess("");
                        } else {
                            var thankYouPage = that._thankYouPage;
                            var query = "?u=" + that.DATA.userid + queryString(thankYouPage.queryParams);
                            window.location.href = thankYouPage.url + query;
                        }
                    }
                },
                error: function () {
                    ev.complete("fail");
                    that._onError("Unknown error.");
                },
                complete: function() {
                    that._onAjaxComplete();
                }
            });
        });
    },
    _wireUpButton: function (buttonEl) {
        var that = this;
        $(buttonEl).click(function() {
            that._buttonClickCallback();
            if (that._buttonClickPreCheck() === false || $(buttonEl).hasClass("disabled")) {
                return false;
            }

            that.DATA.amount_cents = that._getAmountCents();
            const pmtRecurs = that._recurring();
            function capitalizeFirst(string) {
                if (typeof string !== "string" || string.length === 0) {
                    return string;
                }
                return string[0].toUpperCase() + string.slice(1);
            }
            const recurringInterval = capitalizeFirst(that._getSubType());
            var paymentWindowLabel = pmtRecurs === true ? "Adblock " + recurringInterval : "Adblock";
            _logV2PaymentButtonClick("Stripe", that.DATA.amount_cents, that._buttonType, pmtRecurs, that._getSubType());
            that._paymentRequest.update({
                currency: that._currency().toLowerCase(),
                total: {
                    label: paymentWindowLabel,
                    amount: that.DATA.amount_cents,
                    pending: false
                }
            });
            that._paymentRequest.show(); // Show the payment request screen.
        });
    }
};
@2+óïõ      \ö’≠\ö’≠@0S[\üyé   C    :https://getadblock.com/js/payment/lib/payment_libs.js?v=1550179537 strongly-framed 1 security-info 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 request-method GET response-head HTTP/1.1 200 OK
Server: nginx
Date: Wed, 27 Mar 2019 01:45:17 GMT
Content-Type: application/javascript
Content-Length: 32615
Last-Modified: Tue, 19 Feb 2019 21:02:21 GMT
ETag: "7f67-582458eb23267"
Accept-Ranges: bytes
 original-response-headers Server: nginx
Date: Wed, 27 Mar 2019 01:45:17 GMT
Content-Type: application/javascript
Content-Length: 32615
Connection: keep-alive
Last-Modified: Tue, 19 Feb 2019 21:02:21 GMT
ETag: "7f67-582458eb23267"
Accept-Ranges: bytes
 uncompressed-len 0 net-response-time-onstart 328 net-response-time-onstop 371   g